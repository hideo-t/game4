<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>é¢¨èˆ¹å‰²ã‚Šå ã„ - Aura Oracle</title>
  <style>
    :root{ color-scheme: dark; }
    html,body{ height:100%; margin:0; }
    body{
      background:#050810;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      overscroll-behavior:none;
      -webkit-tap-highlight-color:transparent;
      touch-action:none;
      user-select:none;
    }
    #wrap{
      position:fixed; inset:0;
      display:grid;
      grid-template-rows:auto 1fr auto;
      padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom) 10px;
      gap:8px;
    }
    .hud{
      display:flex; justify-content:space-between; align-items:center;
      gap:8px; flex-wrap:wrap;
      padding: 8px 6px 0;
      color:rgba(235,242,255,.92);
    }
    .left{ display:flex; gap:10px; flex-wrap:wrap; }
    .pill{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 7px 10px;
      border-radius:999px;
      font-size:13px;
      backdrop-filter: blur(8px);
    }
    .btns{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      cursor:pointer;
      background: rgba(120,190,255,.18);
      border: 1px solid rgba(120,190,255,.35);
      color:#eaf3ff;
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 900;
      letter-spacing:.02em;
    }
    .btn:active{ transform: translateY(1px); }
    canvas{
      width:100%;
      height:100%;
      display:block;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(1200px 700px at 50% 120%, rgba(110,170,255,.16), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .foot{
      color: rgba(215,225,255,.75);
      font-size:12px;
      padding:0 6px 10px;
      text-align:center;
      line-height:1.6;
    }

    /* çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ï¼‰ */
    .overlay{
      position:fixed; inset:0;
      display:none;
      z-index:20;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .overlay.show{ display:grid; grid-template-rows:auto 1fr auto; gap:10px; }
    .topbar{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      color: rgba(235,242,255,.95);
    }
    .topbar .ttl{ font-weight: 1000; letter-spacing:.02em; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn2{
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(235,242,255,.95);
    }
    .btn2:active{ transform: translateY(1px); }

    .cardWrap{
      display:grid;
      place-items:center;
    }
    .resultCard{
      width: min(560px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,14,26,.78);
      box-shadow: 0 22px 90px rgba(0,0,0,.55);
      padding: 14px;
      position: relative;
      overflow:hidden;
    }
    .resultCard:before{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 0deg, rgba(255,255,255,.0), rgba(255,255,255,.08), rgba(255,255,255,.0));
      animation: spin 6s linear infinite;
      opacity:.55;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .resultInner{
      position:relative;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 14px;
    }
    .row2{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 12px;
      align-items:center;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      font-weight: 900;
      width: fit-content;
    }
    .h1{
      font-size: 18px;
      font-weight: 1000;
      margin: 8px 0 0;
      letter-spacing:.02em;
    }
    .desc{
      opacity:.88;
      font-size: 13px;
      line-height:1.75;
      margin-top: 8px;
      white-space: pre-line;
    }
    .mini{
      opacity:.7;
      font-size: 12px;
      margin-top: 10px;
      line-height:1.6;
    }
    .spark{
      display:flex; gap:6px; flex-wrap:wrap; margin-top: 10px;
    }
    .chip{
      font-size: 12px;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      opacity: .92;
    }
    .bottomNote{
      color: rgba(235,242,255,.72);
      font-size:12px;
      line-height:1.6;
      text-align:center;
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="hud">
      <div class="left">
        <div class="pill">SCORE: <span id="score">0</span></div>
        <div class="pill">COMBO: <span id="combo">0</span></div>
        <div class="pill">POPS: <span id="pops">0</span>/10</div>
        <div class="pill">TIME: <span id="time">30.0</span>s</div>
      </div>
      <div class="btns">
        <button class="btn" id="btnStart">START</button>
        <button class="btn" id="btnRestart">RESTART</button>
      </div>
    </div>

    <canvas id="game"></canvas>

    <div class="foot">
      é¢¨èˆ¹ã‚’ã‚¿ãƒƒãƒ—ã§å‰²ã‚‹ï¼ˆ10å€‹ or 30ç§’ï¼‰â†’ ã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«å ã„ã‚«ãƒ¼ãƒ‰ãŒå‡ºã‚‹ã€‚<br>
      iPhoneã¯ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ã§ã‚¢ãƒ—ãƒªã¿ãŸã„ã«ä½¿ãˆã‚‹
    </div>
  </div>

  <!-- çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="overlay" id="overlay">
    <div class="topbar">
      <div class="ttl">å ã„çµæœã‚«ãƒ¼ãƒ‰</div>
      <div class="actions">
        <button class="btn2" id="btnShare">å…±æœ‰</button>
        <button class="btn2" id="btnCopy">ã‚³ãƒ”ãƒ¼</button>
        <button class="btn2" id="btnAgain">ã‚‚ã†ä¸€å›</button>
      </div>
    </div>

    <div class="cardWrap">
      <div class="resultCard" id="resultCard">
        <div class="resultInner" id="resultInner">
          <div class="row2">
            <canvas id="resultViz" width="160" height="160" style="width:160px;height:160px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.15)"></canvas>
            <div>
              <div class="badge" id="rBadge">â€”</div>
              <div class="h1" id="rTitle">â€”</div>
              <div class="desc" id="rDesc">â€”</div>
              <div class="spark" id="rChips"></div>
              <div class="mini" id="rMini">â€”</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="bottomNote">
      â€» å ã„ã¯ã€Œç›´æ„Ÿã®é¸æŠã€ã‚’å¯è¦–åŒ–ã—ãŸéŠã³ã®è¨ºæ–­ã ã‚ˆã€‚çµæœã¯ã‚ãªãŸã®å‘³æ–¹ã¨ã—ã¦ä½¿ã£ã¦ã­ã€‚
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d", { alpha:true });

  const $score = document.getElementById("score");
  const $combo = document.getElementById("combo");
  const $pops  = document.getElementById("pops");
  const $time  = document.getElementById("time");
  const btnStart = document.getElementById("btnStart");
  const btnRestart = document.getElementById("btnRestart");

  const overlay = document.getElementById("overlay");
  const btnShare = document.getElementById("btnShare");
  const btnCopy  = document.getElementById("btnCopy");
  const btnAgain = document.getElementById("btnAgain");

  const rBadge = document.getElementById("rBadge");
  const rTitle = document.getElementById("rTitle");
  const rDesc  = document.getElementById("rDesc");
  const rMini  = document.getElementById("rMini");
  const rChips = document.getElementById("rChips");

  const viz = document.getElementById("resultViz");
  const vctx = viz.getContext("2d");

  function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
  function rand(a,b){ return a + Math.random()*(b-a); }

  // --- é«˜DPI ---
  function resize(){
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height= Math.floor(rect.height* dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", resize);

  // ---- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ----
  let W=0,H=0;
  let running=false, finished=false;
  let score=0, combo=0, timeLeft=30.0;
  const targetPops=10;
  const popLog=[]; // {t,colorKey,x,y}
  let startAt=0;

  // --- ãƒ‘ãƒ¬ãƒƒãƒˆ ---
  const palette = [
    { key:"RED", hex:"#ff4d6d", name:"ç´…" },
    { key:"YEL", hex:"#ffb703", name:"é»„" },
    { key:"BLU", hex:"#4cc9f0", name:"é’" },
    { key:"GRN", hex:"#8aff7a", name:"ç·‘" },
    { key:"PUR", hex:"#b517ff", name:"ç´«" },
    { key:"PNK", hex:"#f72585", name:"æ¡ƒ" },
    { key:"CYN", hex:"#00f5d4", name:"ç¢§" },
    { key:"LAV", hex:"#ffd6ff", name:"éœ" },
  ];

  const meta = {
    RED:{ type:"ç«", title:"ç´…è“®ã®çªç ´è€…", core:"å‹¢ã„ãƒ»æ±ºæ–­ãƒ»å‰é€²", hint:"è¿·ã„ã‚’ç‡ƒæ–™ã«å¤‰ãˆã‚‰ã‚Œã‚‹æ—¥ã€‚å°ã•ãè¸ã¿å‡ºã™ã»ã©é“ãŒé–‹ãã€‚", word:["ä¸€æ­©ç›®ãŒå‹ã¡","å³æ–­å³å‹•"] },
    BLU:{ type:"æ°´", title:"è’¼ã®è¦³æ¸¬è€…", core:"æ•´ç†ãƒ»è¦³å¯Ÿãƒ»æœ€é©åŒ–", hint:"ç­”ãˆã¯é™ã‘ã•ã®ä¸­ã€‚ä»Šæ—¥ã¯æ•´ãˆã‚‹ã»ã©å‹ç‡ãŒä¸ŠãŒã‚‹ã€‚", word:["æ•´ãˆã‚‹","ä¿¯ç°"] },
    GRN:{ type:"æœ¨", title:"ç¿ ã®è‚²æˆè€…", core:"å›å¾©ãƒ»èª¿å’Œãƒ»ç¶™ç¶š", hint:"æ´¾æ‰‹ã•ã‚ˆã‚Šç©ã¿ä¸Šã’ã€‚è‚²ã¦ãŸã‚‚ã®ãŒæœªæ¥ã§åŠ¹ãæ—¥ã€‚", word:["ç©ã¿ä¸Šã’","å®‰å¿ƒ"] },
    YEL:{ type:"é¢¨", title:"é»„é‡‘ã®ç™ºè¦‹è€…", core:"å¥½å¥‡å¿ƒãƒ»éŠã³ãƒ»ã²ã‚‰ã‚ã", hint:"é¢ç™½ã„æ–¹ãŒæ­£è§£ã«ãªã‚Šã‚„ã™ã„ã€‚è©¦ã—ãŸåˆ†ã ã‘å½“ãŸã‚Šã«è¿‘ã¥ãã€‚", word:["è»½ã‚„ã‹","å®Ÿé¨“"] },
    PUR:{ type:"æ˜Ÿ", title:"ç´«å®™ã®ç›´æ„Ÿå¸«", core:"ç›´æ„Ÿãƒ»ç¾æ„è­˜ãƒ»æµã‚Œ", hint:"è¨€èªåŒ–å‰ã®ã²ã‚‰ã‚ããŒå®ã€‚æµ®ã‹ã‚“ã æ¡ˆã¯ä¸€æ—¦ãƒ¡ãƒ¢ãŒæ­£è§£ã€‚", word:["ç›´æ„Ÿ","ç¾å­¦"] },
    PNK:{ type:"èŠ±", title:"æ¡ƒèŠ±ã®å…±é³´è€…", core:"å…±æ„Ÿãƒ»é­…åŠ›ãƒ»é–¢ä¿‚", hint:"è¨€è‘‰ãŒé‹ã‚’é‹ã¶æ—¥ã€‚æŸ”ã‚‰ã‹ã„ä¸€è¨€ãŒçŠ¶æ³ã‚’å¤‰ãˆã‚‹ã€‚", word:["ã‚„ã•ã—ã•","ã¤ãªãŒã‚Š"] },
    CYN:{ type:"ç©º", title:"ç¢§ç©ºã®åˆ·æ–°è€…", core:"è‡ªç”±ãƒ»æ›´æ–°ãƒ»è§£æ”¾", hint:"æ ã‚’å¤–ã™ã»ã©æ¥½ã«ãªã‚‹ã€‚å¤ã„æ­£è§£ã‚ˆã‚Šæ–°ã—ã„è©¦ã—æ–¹ã¸ã€‚", word:["åˆ·æ–°","è§£æ”¾"] },
    LAV:{ type:"æœˆ", title:"éœæœˆã®èªã‚Šæ‰‹", core:"ä½™éŸ»ãƒ»æ„Ÿå—æ€§ãƒ»ç‰©èª", hint:"æ€¥ãŒãªã„é¸æŠã‚‚æ­£è§£ã€‚ä½™ç™½ã«ãƒ’ãƒ³ãƒˆãŒè½ã¡ã¦ã„ã‚‹æ—¥ã€‚", word:["ä½™ç™½","ç‰©èª"] },
  };

  // ---- ãƒãƒ–ãƒ«/ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆãƒªãƒƒãƒåŒ–ï¼‰ ----
  const bubbles=[];
  const particles=[];
  const auroras=[]; // èƒŒæ™¯ã‚†ã‚‰ã

  function syncHUD(){
    $score.textContent = String(score);
    $combo.textContent = String(combo);
    $pops.textContent  = `${popLog.length}/${targetPops}`;
    $time.textContent  = timeLeft.toFixed(1);
  }

  function reset(){
    running=false; finished=false;
    score=0; combo=0; timeLeft=30.0;
    bubbles.length=0; particles.length=0; auroras.length=0;
    popLog.length=0; startAt=0;
    hideResult();
    syncHUD();
  }

  function spawnBubble(){
    const minDim = Math.min(W,H);
    const r = rand(minDim*0.055, minDim*0.10);
    const x = rand(r+12, W-r-12);
    const y = rand(r+12, H-r-12);
    const life = rand(1.0, 1.7);
    const drift = { x: rand(-26, 26), y: rand(-22, 22) };
    const grow = rand(0.85, 1.35);
    const p = palette[Math.floor(Math.random()*palette.length)];

    bubbles.push({
      x,y,r,t:0,life,grow,drift,
      color:p.hex, key:p.key,
      shimmer: rand(0, Math.PI*2),
      ring: rand(0.12, 0.22)
    });
  }

  function popFx(x,y,color,baseR){
    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«å¤šã‚
    const n = 28 + Math.floor(Math.random()*18);
    for(let i=0;i<n;i++){
      const a = Math.random()*Math.PI*2;
      const sp = rand(140, 460);
      particles.push({
        x,y,
        vx: Math.cos(a)*sp,
        vy: Math.sin(a)*sp,
        r: rand(1.6, 4.6),
        t:0, life: rand(0.35, 0.85),
        color,
        tw: rand(0.6, 1.4)
      });
    }
    // ã‚ªãƒ¼ãƒ©ã®è¼ª
    particles.push({ x,y, vx:0, vy:0, r: baseR*0.55, t:0, life:0.55, color, ring:true });

    // èƒŒæ™¯ã‚ªãƒ¼ãƒ­ãƒ©è¿½åŠ 
    auroras.push({
      x, y,
      r: baseR*2.6,
      t:0,
      life: 0.9,
      color
    });
  }

  // ---- å…¥åŠ› ----
  function toggle(){
    if (finished) return;
    running = !running;
    if (running && !startAt) startAt = performance.now();
  }

  btnStart.addEventListener("click", () => { if(!finished){ running=true; if(!startAt) startAt=performance.now(); } });
  btnRestart.addEventListener("click", () => reset());
  window.addEventListener("keydown",(e)=>{ if(e.key===" "){ e.preventDefault(); toggle(); } }, {passive:false});

  function pointerPos(e){
    const rect = canvas.getBoundingClientRect();
    return { x: e.clientX-rect.left, y: e.clientY-rect.top };
  }

  function tryHit(x,y){
    for(let i=bubbles.length-1;i>=0;i--){
      const b=bubbles[i];
      const dx=x-b.x, dy=y-b.y;
      if(dx*dx+dy*dy<=b.r*b.r){
        bubbles.splice(i,1);
        const now = performance.now();
        popLog.push({
          t: startAt ? (now-startAt)/1000 : 0,
          colorKey: b.key,
          x: b.x/Math.max(1,W),
          y: b.y/Math.max(1,H),
        });

        combo += 1;
        const bonus = Math.floor(10*(1+Math.min(10,combo)*0.22));
        score += bonus;
        timeLeft = clamp(timeLeft + 0.10, 0, 60);

        popFx(b.x,b.y,b.color,b.r);
        syncHUD();

        if (popLog.length>=targetPops) finish();
        return true;
      }
    }
    combo=0; syncHUD();
    return false;
  }

  canvas.addEventListener("pointerdown",(e)=>{
    canvas.setPointerCapture?.(e.pointerId);
    if(!running && !finished){ running=true; if(!startAt) startAt=performance.now(); }
    const p = pointerPos(e);
    tryHit(p.x,p.y);
  });

  // ---- å ã„è§£æï¼ˆã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«å‘ã‘ã‚¹ã‚³ã‚¢åŒ–ï¼‰ ----
  function analyze(log){
    const cnt={};
    for(const p of log) cnt[p.colorKey]=(cnt[p.colorKey]||0)+1;

    let mainKey="BLU", mainN=-1;
    for(const k in cnt){ if(cnt[k]>mainN){ mainN=cnt[k]; mainKey=k; } }

    const times = log.map(z=>z.t).sort((a,b)=>a-b);
    let avgGap=999;
    if(times.length>=2){
      let s=0;
      for(let i=1;i<times.length;i++) s += (times[i]-times[i-1]);
      avgGap = s/(times.length-1);
    }

    // ç«¯å¯„ã‚Šï¼ˆæ¢ç´¢å¿—å‘ï¼‰
    const edge = log.reduce((a,p)=>{
      const dx=Math.abs(p.x-0.5), dy=Math.abs(p.y-0.5);
      return a + (dx+dy);
    },0)/Math.max(1,log.length);

    // ãƒãƒ©ã¤ãï¼ˆæ„Ÿæƒ…ã®æ³¢ï¼‰
    let varGap=0;
    if(times.length>=3){
      const gaps=[];
      for(let i=1;i<times.length;i++) gaps.push(times[i]-times[i-1]);
      const m=gaps.reduce((a,b)=>a+b,0)/gaps.length;
      varGap = gaps.reduce((a,g)=>a+(g-m)*(g-m),0)/gaps.length;
    }

    // ãƒ¬ãƒ¼ãƒ€ãƒ¼ç”¨4è»¸ï¼ˆ0..1ï¼‰
    // ç›´æ„Ÿ(é€Ÿã•) / å®‰å®š(ã°ã‚‰ã¤ãé€†) / æ¢ç´¢(ç«¯å¯„ã‚Š) / é›†ä¸­(ã‚³ãƒ³ãƒœå¼·ã‚ã«åæ˜ )
    const intuition = clamp(1 - avgGap/1.2, 0, 1);
    const stable    = clamp(1 - Math.sqrt(varGap)/0.9, 0, 1);
    const explore   = clamp((edge-0.40)/0.35, 0, 1);
    const focus     = clamp((Math.min(10, combo))/10, 0, 1);

    return { cnt, mainKey, avgGap, edge, intuition, stable, explore, focus };
  }

  function topColors(cnt){
    return Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,3)
      .map(([k,n]) => `${(palette.find(p=>p.key===k)?.name||k)}Ã—${n}`);
  }

  function moodBadge(avgGap){
    if(avgGap<=0.55) return "å³æ–­ãƒ¢ãƒ¼ãƒ‰";
    if(avgGap<=0.95) return "å®‰å®šãƒ¢ãƒ¼ãƒ‰";
    return "ç†Ÿè€ƒãƒ¢ãƒ¼ãƒ‰";
  }

  function quoteFor(k){
    const m = meta[k] || meta.BLU;
    const options = [
      `è¿·ã£ãŸã‚‰ã€Œå°ã•ãè©¦ã™ã€ã€‚`,
      `ä»Šæ—¥ã¯ã€Œæ•´ãˆã‚‹ã€ã»ã©ä¼¸ã³ã‚‹ã€‚`,
      `è»½ã„æ–¹ã¸å‹•ãã¨é‹ãŒä¹—ã‚‹ã€‚`,
      `ç›´æ„Ÿãƒ¡ãƒ¢ãŒæœªæ¥ã‚’åŠ©ã‘ã‚‹ã€‚`,
      `è¨€è‘‰ãŒé‹ã‚’é‹ã¶ã€‚`,
      `æ ã‚’å¤–ã™ã»ã©æ¥½ã«ãªã‚‹ã€‚`,
      `ä½™ç™½ã«ãƒ’ãƒ³ãƒˆãŒè½ã¡ã¦ã‚‹ã€‚`,
    ];
    // ãƒ¡ã‚¿ã®ãƒ’ãƒ³ãƒˆã‚’æ··ãœã‚‹
    return (Math.random()<0.55) ? m.hint : options[Math.floor(Math.random()*options.length)];
  }

  // ---- çµæœæç”»ï¼ˆãƒ¬ãƒ¼ãƒ€ãƒ¼ï¼‹ã‚ªãƒ¼ãƒ©ï¼‰ ----
  function drawResultViz(mainKey, a){
    const m = meta[mainKey] || meta.BLU;
    const base = (palette.find(p=>p.key===mainKey)?.hex) || "#4cc9f0";

    const w=viz.width, h=viz.height;
    vctx.clearRect(0,0,w,h);

    // èƒŒæ™¯ã‚°ãƒ­ãƒ¼
    const cx=w/2, cy=h/2;
    const g = vctx.createRadialGradient(cx,cy,10,cx,cy,78);
    g.addColorStop(0, hexToRgba(base,0.55));
    g.addColorStop(1, "rgba(0,0,0,0)");
    vctx.fillStyle=g;
    vctx.beginPath(); vctx.arc(cx,cy,78,0,Math.PI*2); vctx.fill();

    // ã‚¬ã‚¤ãƒ‰å††
    vctx.lineWidth=1;
    vctx.strokeStyle="rgba(255,255,255,.14)";
    for(const r of [22,40,58,76]){
      vctx.beginPath(); vctx.arc(cx,cy,r,0,Math.PI*2); vctx.stroke();
    }

    // ãƒ¬ãƒ¼ãƒ€ãƒ¼ï¼ˆ4è»¸ï¼‰
    const axes = [
      {name:"ç›´æ„Ÿ", v:a.intuition, ang:-Math.PI/2},
      {name:"å®‰å®š", v:a.stable,    ang:-Math.PI/2 + Math.PI/2},
      {name:"æ¢ç´¢", v:a.explore,   ang:-Math.PI/2 + Math.PI},
      {name:"é›†ä¸­", v:a.focus,     ang:-Math.PI/2 + Math.PI*1.5},
    ];

    // è»¸ç·š
    vctx.strokeStyle="rgba(255,255,255,.18)";
    for(const ax of axes){
      const x = cx + Math.cos(ax.ang)*78;
      const y = cy + Math.sin(ax.ang)*78;
      vctx.beginPath(); vctx.moveTo(cx,cy); vctx.lineTo(x,y); vctx.stroke();
    }

    // é¢
    vctx.beginPath();
    axes.forEach((ax, i)=>{
      const r = 18 + ax.v*58;
      const x = cx + Math.cos(ax.ang)*r;
      const y = cy + Math.sin(ax.ang)*r;
      if(i===0) vctx.moveTo(x,y); else vctx.lineTo(x,y);
    });
    vctx.closePath();
    vctx.fillStyle = hexToRgba(base, 0.28);
    vctx.fill();
    vctx.lineWidth=2;
    vctx.strokeStyle = hexToRgba(base, 0.65);
    vctx.stroke();

    // ä¸­å¤®ãƒãƒ¼ã‚¯
    vctx.fillStyle="rgba(255,255,255,.92)";
    vctx.beginPath(); vctx.arc(cx,cy,3.2,0,Math.PI*2); vctx.fill();

    // ã‚¿ã‚¤ãƒ—æ–‡å­—
    vctx.fillStyle="rgba(255,255,255,.90)";
    vctx.font="900 12px system-ui,-apple-system,'Noto Sans JP',sans-serif";
    vctx.textAlign="center";
    vctx.fillText(`${m.type}å±æ€§`, cx, h-14);
  }

  function hexToRgba(hex,a){
    const h=hex.replace("#","");
    const r=parseInt(h.slice(0,2),16);
    const g=parseInt(h.slice(2,4),16);
    const b=parseInt(h.slice(4,6),16);
    return `rgba(${r},${g},${b},${a})`;
  }

  // ---- çµæœç”Ÿæˆ/è¡¨ç¤º ----
  let lastResultText = "";

  function finish(){
    running=false;
    finished=true;

    const a = analyze(popLog);
    const m = meta[a.mainKey] || meta.BLU;
    const badge = moodBadge(a.avgGap);
    const top = topColors(a.cnt);

    const q = quoteFor(a.mainKey);

    rBadge.textContent = `${badge} / ${m.type}å±æ€§`;
    rTitle.textContent = m.title;
    rDesc.textContent =
      `æ ¸ï¼š${m.core}\n` +
      `å‚¾å‘ï¼š${m.hint}\n` +
      `ä»Šæ—¥ã®ã‚­ãƒ¼ï¼š${q}`;

    // ãƒãƒƒãƒ—ï¼ˆè¦–è¦šï¼‰
    rChips.innerHTML = "";
    const chips = [
      `è‰²ï¼š${top.join(" / ")}`,
      `ç›´æ„Ÿï¼š${Math.round(a.intuition*100)}%`,
      `å®‰å®šï¼š${Math.round(a.stable*100)}%`,
      `æ¢ç´¢ï¼š${Math.round(a.explore*100)}%`,
      `é›†ä¸­ï¼š${Math.round(a.focus*100)}%`,
    ];
    chips.forEach(t=>{
      const d=document.createElement("div");
      d.className="chip";
      d.textContent=t;
      rChips.appendChild(d);
    });

    rMini.textContent = `SCORE: ${score} / å‰²ã£ãŸæ•°: ${popLog.length} / å¹³å‡ãƒ†ãƒ³ãƒ: ${a.avgGap.toFixed(2)}s`;

    drawResultViz(a.mainKey, a);

    lastResultText =
`é¢¨èˆ¹å‰²ã‚Šå ã„ï¼š${m.title}ï¼ˆ${badge} / ${m.type}å±æ€§ï¼‰
æ ¸ï¼š${m.core}
è‰²ï¼š${top.join(" / ")}
ç›´æ„Ÿ${Math.round(a.intuition*100)}% å®‰å®š${Math.round(a.stable*100)}% æ¢ç´¢${Math.round(a.explore*100)}% é›†ä¸­${Math.round(a.focus*100)}%
ä»Šæ—¥ã®ã‚­ãƒ¼ï¼š${q}`;

    showResult();
  }

  function showResult(){ overlay.classList.add("show"); }
  function hideResult(){ overlay.classList.remove("show"); }

  btnAgain.addEventListener("click", ()=> reset());

  btnCopy.addEventListener("click", async ()=>{
    const text = lastResultText + "\n" + location.href;
    try{
      await navigator.clipboard.writeText(text);
      btnCopy.textContent = "ã‚³ãƒ”ãƒ¼ã—ãŸï¼";
      setTimeout(()=>btnCopy.textContent="ã‚³ãƒ”ãƒ¼", 1200);
    }catch{
      prompt("ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã£ã¦ã­ğŸ‘‡", text);
    }
  });

  btnShare.addEventListener("click", async ()=>{
    const text = lastResultText;
    // ç”»åƒå…±æœ‰ã¯iOSã§åˆ¶é™ãŒã‚ã‚‹ã®ã§ã€ã¾ãšãƒ†ã‚­ã‚¹ãƒˆå…±æœ‰ã‚’ç¢ºå®Ÿã«
    try{
      if (navigator.share){
        await navigator.share({ title:"é¢¨èˆ¹å‰²ã‚Šå ã„", text, url: location.href });
      } else {
        await navigator.clipboard.writeText(text + "\n" + location.href);
        alert("å…±æœ‰æ©Ÿèƒ½ãŒãªã„ã®ã§ã€çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆã€‚");
      }
    }catch{
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã©
    }
  });

  // ---- ãƒ«ãƒ¼ãƒ— ----
  let spawnTimer=0;
  let last=performance.now();

  function update(dt){
    if(!running || finished) return;

    timeLeft -= dt;
    if(timeLeft<=0){
      timeLeft=0;
      $time.textContent=timeLeft.toFixed(1);
      finish();
      return;
    }
    $time.textContent=timeLeft.toFixed(1);

    const difficulty = 1 + (30 - timeLeft)/30;
    const interval = clamp(0.30 / difficulty, 0.12, 0.30);

    spawnTimer += dt;
    while(spawnTimer >= interval){
      spawnTimer -= interval;
      spawnBubble();
      if(bubbles.length>24) bubbles.shift();
    }

    // ãƒãƒ–ãƒ«æ›´æ–°
    for(let i=bubbles.length-1;i>=0;i--){
      const b=bubbles[i];
      b.t += dt;
      b.shimmer += dt*2.2;

      b.x += b.drift.x * dt;
      b.y += b.drift.y * dt;

      if (b.x - b.r < 10 || b.x + b.r > W - 10) b.drift.x *= -1;
      if (b.y - b.r < 10 || b.y + b.r > H - 10) b.drift.y *= -1;

      b.r *= (1 + dt * 0.16 * b.grow);

      if(b.t >= b.life){
        bubbles.splice(i,1);
        combo=0;
        syncHUD();
      }
    }

    // èƒŒæ™¯ã‚ªãƒ¼ãƒ­ãƒ©
    for(let i=auroras.length-1;i>=0;i--){
      const a=auroras[i];
      a.t += dt;
      if(a.t>=a.life){ auroras.splice(i,1); continue; }
      a.r *= (1 + dt*0.55);
    }

    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.t += dt;
      if(p.t>=p.life){ particles.splice(i,1); continue; }
      if(!p.ring){
        p.vy += 560*dt;
        p.x += p.vx*dt;
        p.y += p.vy*dt;
        p.vx *= (1 - dt*2.0);
        p.vy *= (1 - dt*1.4);
      } else {
        p.r *= (1 + dt*2.0);
      }
    }
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // èƒŒæ™¯ã‚°ãƒ©ãƒ‡ + ã‚ªãƒ¼ãƒ­ãƒ©
    // æ˜Ÿ
    ctx.globalAlpha=0.22;
    for(let i=0;i<90;i++){
      const x=(i*97)%W, y=(i*173)%H;
      ctx.fillStyle="white";
      ctx.fillRect(x,y,1,1);
    }
    ctx.globalAlpha=1;

    // ã‚ªãƒ¼ãƒ­ãƒ©ï¼ˆå‰²ã£ãŸè‰²ãŒèƒŒæ™¯ã«æ®‹ã‚‹ï¼‰
    for(const a of auroras){
      const t = a.t/a.life;
      const alpha = 0.18*(1-t);
      const g = ctx.createRadialGradient(a.x,a.y,10,a.x,a.y,a.r);
      g.addColorStop(0, hexToRgba(a.color, alpha));
      g.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle=g;
      ctx.beginPath(); ctx.arc(a.x,a.y,a.r,0,Math.PI*2); ctx.fill();
    }

    // ãƒãƒ–ãƒ«
    for(const b of bubbles){
      const life01 = clamp(1 - (b.t / b.life), 0, 1);

      // å½±
      ctx.beginPath();
      ctx.arc(b.x,b.y,b.r*1.10,0,Math.PI*2);
      ctx.fillStyle="rgba(0,0,0,.22)";
      ctx.fill();

      // æœ¬ä½“ï¼ˆè¼ãï¼‰
      const g = ctx.createRadialGradient(
        b.x - b.r*(0.45+0.08*Math.sin(b.shimmer)),
        b.y - b.r*(0.45+0.08*Math.cos(b.shimmer)),
        b.r*0.22,
        b.x, b.y, b.r
      );
      g.addColorStop(0, "rgba(255,255,255,.78)");
      g.addColorStop(0.30, b.color + "CC");
      g.addColorStop(1, b.color + "44");

      ctx.beginPath();
      ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
      ctx.fillStyle=g;
      ctx.fill();

      // ãƒªãƒ³ã‚°
      ctx.lineWidth = Math.max(2, b.r*b.ring);
      ctx.strokeStyle = "rgba(255,255,255,.60)";
      ctx.globalAlpha = 0.35 + 0.45*life01;
      ctx.stroke();
      ctx.globalAlpha = 1;

      // å¯¿å‘½å¼§
      ctx.beginPath();
      ctx.arc(b.x,b.y,b.r*0.88,-Math.PI/2,-Math.PI/2 + Math.PI*2*life01);
      ctx.lineWidth=3;
      ctx.strokeStyle="rgba(255,255,255,.32)";
      ctx.stroke();
    }

    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
    for(const p of particles){
      const a = 1 - (p.t/p.life);
      if(p.ring){
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.lineWidth=4;
        ctx.strokeStyle=hexToRgba(p.color, 0.60*a);
        ctx.stroke();
        continue;
      }
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle=hexToRgba(p.color, 0.95*a);
      ctx.fill();
    }

    // ãƒ†ã‚­ã‚¹ãƒˆ
    if(!running && !finished && popLog.length===0){
      centerText("é¢¨èˆ¹ã‚’å‰²ã£ã¦å ã„é–‹å§‹", H*0.52, 18, "rgba(235,242,255,.92)");
      centerText("10å€‹å‰²ã‚‹ã‹ 30ç§’ã§ çµæœã‚«ãƒ¼ãƒ‰ãŒå‡ºã‚‹", H*0.60, 13, "rgba(235,242,255,.72)");
    }
  }

  function centerText(text,y,size,color){
    ctx.fillStyle=color;
    ctx.font=`900 ${size}px system-ui,-apple-system,"Noto Sans JP",sans-serif`;
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(text, W/2, y);
  }

  function loop(now){
    const dt = Math.min(0.033, (now-last)/1000);
    last=now;
    const rect = canvas.getBoundingClientRect();
    W=rect.width; H=rect.height;

    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  // åˆæœŸåŒ–
  requestAnimationFrame(()=>{
    resize();
    reset();
    requestAnimationFrame(loop);
  });
})();
</script>
</body>
</html>